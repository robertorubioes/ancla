#------------------------------------------------------------------------------
# Firmalum - Docker Compose for Local Development
#------------------------------------------------------------------------------
# This configuration provides a consistent development environment
# matching the production stack (MySQL, Redis, MinIO for S3).
#
# Usage:
#   docker compose up -d          # Start all services
#   docker compose logs -f app    # View app logs
#   docker compose down           # Stop all services
#   docker compose down -v        # Stop and remove volumes
#
# Access:
#   App:     http://localhost:8000
#   MinIO:   http://localhost:9001 (admin/admin123)
#   MySQL:   localhost:3306
#   Redis:   localhost:6379
#   Mailpit: http://localhost:8025
#------------------------------------------------------------------------------

name: firmalum

services:
  #----------------------------------------------------------------------------
  # Application Server (PHP-FPM + Nginx)
  #----------------------------------------------------------------------------
  app:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: development
    container_name: firmalum_app
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - .:/var/www/html
      - ./docker/php/local.ini:/usr/local/etc/php/conf.d/local.ini
    networks:
      - firmalum_network
    depends_on:
      - mysql
      - redis
    environment:
      - PHP_MEMORY_LIMIT=256M
      - PHP_MAX_EXECUTION_TIME=120

  #----------------------------------------------------------------------------
  # Nginx Web Server
  #----------------------------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: firmalum_nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - .:/var/www/html
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
    networks:
      - firmalum_network
    depends_on:
      - app

  #----------------------------------------------------------------------------
  # MySQL Database
  #----------------------------------------------------------------------------
  mysql:
    image: mysql:8.0
    container_name: firmalum_mysql
    restart: unless-stopped
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: firmalum
      MYSQL_USER: firmalum
      MYSQL_PASSWORD: firmalum
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - firmalum_network
    command: --default-authentication-plugin=mysql_native_password

  #----------------------------------------------------------------------------
  # Redis Cache & Queue
  #----------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: firmalum_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - firmalum_network
    command: redis-server --appendonly yes

  #----------------------------------------------------------------------------
  # MinIO (S3-compatible storage)
  #----------------------------------------------------------------------------
  minio:
    image: minio/minio
    container_name: firmalum_minio
    restart: unless-stopped
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: admin123
    volumes:
      - minio_data:/data
    networks:
      - firmalum_network
    command: server /data --console-address ":9001"

  #----------------------------------------------------------------------------
  # MinIO Setup (creates buckets on start)
  #----------------------------------------------------------------------------
  minio-setup:
    image: minio/mc
    container_name: firmalum_minio_setup
    depends_on:
      - minio
    networks:
      - firmalum_network
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      mc alias set myminio http://minio:9000 admin admin123;
      mc mb myminio/firmalum-storage --ignore-existing;
      mc mb myminio/firmalum-documents --ignore-existing;
      mc mb myminio/firmalum-evidence --ignore-existing;
      mc anonymous set download myminio/firmalum-storage/public;
      echo 'MinIO buckets created successfully';
      exit 0;
      "

  #----------------------------------------------------------------------------
  # Mailpit (Email testing)
  #----------------------------------------------------------------------------
  mailpit:
    image: axllent/mailpit
    container_name: firmalum_mailpit
    restart: unless-stopped
    ports:
      - "8025:8025"   # Web UI
      - "1025:1025"   # SMTP
    networks:
      - firmalum_network

  #----------------------------------------------------------------------------
  # Queue Worker
  #----------------------------------------------------------------------------
  queue:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: development
    container_name: firmalum_queue
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - .:/var/www/html
    networks:
      - firmalum_network
    depends_on:
      - mysql
      - redis
    command: php artisan queue:work redis --sleep=3 --tries=3 --max-time=3600

  #----------------------------------------------------------------------------
  # Scheduler (runs every minute)
  #----------------------------------------------------------------------------
  scheduler:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: development
    container_name: firmalum_scheduler
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - .:/var/www/html
    networks:
      - firmalum_network
    depends_on:
      - mysql
      - redis
    command: >
      /bin/sh -c "while true; do php artisan schedule:run --verbose --no-interaction; sleep 60; done"

#------------------------------------------------------------------------------
# Networks
#------------------------------------------------------------------------------
networks:
  firmalum_network:
    driver: bridge

#------------------------------------------------------------------------------
# Volumes
#------------------------------------------------------------------------------
volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  minio_data:
    driver: local
